<div class="block-dialog-container">
  <!-- Dialog Header -->
  <div mat-dialog-title class="dialog-header">
    <div class="header-left">
      <mat-icon>inventory_2</mat-icon>
      <h2>{{ getDialogTitle() }}</h2>
    </div>
    <button mat-icon-button mat-dialog-close class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Dialog Content -->
  <div mat-dialog-content class="dialog-content">
    <form [formGroup]="blockForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Date of Entry</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="date" />
          <mat-datepicker-toggle
            matSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="blockForm.get('date')?.hasError('required')">
            Required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Pit No</mat-label>
          <mat-select formControlName="pitNo">
            <mat-option *ngFor="let pit of pitNumbers" [value]="pit">
              {{ pit }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="blockForm.get('pitNo')?.hasError('required')">
            Required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Block No</mat-label>
          <input matInput type="number" formControlName="blockNo" />
          <mat-error *ngIf="blockForm.get('blockNo')?.hasError('required')">
            Required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <!-- Block Type - Visible for ALL roles -->
        <mat-form-field appearance="outline">
          <mat-label>Block Type</mat-label>
          <mat-select formControlName="blockType">
            <mat-option *ngFor="let type of blockTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="blockForm.get('blockType')?.hasError('required')">
            Required
          </mat-error>
        </mat-form-field>

        <!-- Buyer Block No - Admin/SuperAdmin only -->
        <mat-form-field appearance="outline" *ngIf="isAdminOrAbove">
          <mat-label>Buyer Block No</mat-label>
          <input matInput type="text" formControlName="buyerBlockNo" />
          <mat-error
            *ngIf="blockForm.get('buyerBlockNo')?.hasError('required')"
          >
            Required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Category Grade</mat-label>
          <mat-select formControlName="categoryGrade">
            <mat-option *ngFor="let grade of categoryGrades" [value]="grade">
              {{ grade }}
            </mat-option>
          </mat-select>
          <mat-error
            *ngIf="blockForm.get('categoryGrade')?.hasError('required')"
          >
            Required
          </mat-error>
        </mat-form-field>

        <!-- Net Weight MT - Admin/SuperAdmin only -->
        <mat-form-field appearance="outline" *ngIf="isAdminOrAbove">
          <mat-label>Net weight in MT</mat-label>
          <input matInput type="number" formControlName="netWeightMt" />
          <mat-error *ngIf="blockForm.get('netWeightMt')?.hasError('required')">
            Required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Measurement Section -->
      <div class="measurement-section">
        <h3>Measurement (LG, WD, HT)</h3>
        <div formGroupName="measurement" class="measurement-row">
          <mat-form-field appearance="outline">
            <mat-label>LG (cm)</mat-label>
            <input matInput type="number" formControlName="lg" />
            <mat-error
              *ngIf="blockForm.get('measurement.lg')?.hasError('required')"
            >
              Required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>WD (cm)</mat-label>
            <input matInput type="number" formControlName="wd" />
            <mat-error
              *ngIf="blockForm.get('measurement.wd')?.hasError('required')"
            >
              Required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>HT (cm)</mat-label>
            <input matInput type="number" formControlName="ht" />
            <mat-error
              *ngIf="blockForm.get('measurement.ht')?.hasError('required')"
            >
              Required
            </mat-error>
          </mat-form-field>

          <!-- DMG Tonnage - Visible for ALL roles (for Govt) -->
          <mat-form-field appearance="outline">
            <mat-label>DMG Tonnage (Govt)</mat-label>
            <input
              matInput
              type="number"
              [value]="calculatedDmgTonnage"
              readonly
              class="calculated-field govt-field"
            />
          </mat-form-field>
        </div>
      </div>

      <!-- Allowance Section - Admin/SuperAdmin only -->
      <div class="allowance-section" *ngIf="isAdminOrAbove">
        <h3>Customer Allowance</h3>

        <!-- Radio Button Toggle -->
        <div class="allowance-toggle">
          <mat-radio-group
            formControlName="allowanceType"
            class="allowance-radio-group"
          >
            <mat-radio-button value="volume" class="allowance-radio">
              <div class="radio-label">
                <mat-icon>straighten</mat-icon>
                <span>Volume Deduction (cm)</span>
              </div>
            </mat-radio-button>
            <mat-radio-button value="tonnage" class="allowance-radio">
              <div class="radio-label">
                <mat-icon>scale</mat-icon>
                <span>Tonnage Deduction (MT)</span>
              </div>
            </mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- Allowance Input Fields -->
        <div class="allowance-inputs">
          <!-- Volume-based Pre Allowance -->
          <mat-form-field
            appearance="outline"
            *ngIf="isVolumeAllowance()"
            class="allowance-field"
          >
            <mat-label>Pre Allowance (cm)</mat-label>
            <mat-select formControlName="preAllowance">
              <mat-option
                *ngFor="let preallwnc of preAllowance"
                [value]="preallwnc"
              >
                {{ preallwnc }} cm - Deduct from LG, WD, HT
              </mat-option>
            </mat-select>
            <mat-hint
              >Deducts {{ blockForm.get("preAllowance")?.value || 0 }} cm from
              each dimension</mat-hint
            >
          </mat-form-field>

          <!-- Tonnage-based Allowance -->
          <mat-form-field
            appearance="outline"
            *ngIf="isTonnageAllowance()"
            class="allowance-field"
          >
            <mat-label>Tonnage Allowance (MT)</mat-label>
            <input
              matInput
              type="number"
              formControlName="tonnageAllowance"
              step="0.01"
              placeholder="Enter tonnes to deduct"
            />
            <mat-hint
              >Deducts directly from DMG Tonnage ({{
                calculatedDmgTonnage
              }}
              MT)</mat-hint
            >
          </mat-form-field>
        </div>
      </div>

      <!-- Calculated Values Section - Admin/SuperAdmin only -->
      <div class="measurement-section" *ngIf="isAdminOrAbove">
        <h3>Calculated Values (For Customer)</h3>
        <div class="measurement-row calculated-row">
          <mat-form-field appearance="outline">
            <mat-label>Quarry CBM (Raw)</mat-label>
            <input
              matInput
              type="number"
              [value]="calculatedQuarryCbm"
              readonly
              class="calculated-field"
            />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Customer Tonnage</mat-label>
            <input
              matInput
              type="number"
              [value]="customerTonnage"
              readonly
              class="calculated-field highlight-customer"
            />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Gross Volume</mat-label>
            <input
              matInput
              type="number"
              [value]="grossVolume"
              readonly
              class="calculated-field"
            />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Net CBM</mat-label>
            <input
              matInput
              type="number"
              [value]="calculatedNetCbm"
              readonly
              class="calculated-field"
            />
          </mat-form-field>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Note</mat-label>
        <textarea matInput rows="3" formControlName="note"></textarea>
      </mat-form-field>
    </form>
  </div>

  <!-- Dialog Actions -->
  <div mat-dialog-actions class="dialog-actions">
    <button
      mat-stroked-button
      type="button"
      (click)="onReset()"
      [disabled]="isSubmitting"
    >
      <mat-icon>refresh</mat-icon>
      Reset
    </button>

    <button
      mat-button
      type="button"
      (click)="onCancel()"
      [disabled]="isSubmitting"
    >
      Cancel
    </button>

    <button
      mat-raised-button
      color="primary"
      type="button"
      (click)="onSubmit()"
      [disabled]="blockForm.invalid || isSubmitting"
    >
      <mat-icon *ngIf="!isSubmitting">save</mat-icon>
      {{ isSubmitting ? "Saving..." : "Save Block" }}
    </button>
  </div>
</div>
